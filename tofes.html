<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<link rel="icon" href="logo.jpg" type="image/jpeg" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>יומן עבודה</title>

<style>
/* ===== Base ===== */
body {
  font-family: Arial, sans-serif;
  background: #ffffff;
  padding: 10px;
  margin: 0;
}

.header-nav {
  display: none;
  max-width: 600px;
  margin: 0 auto 20px auto;
  justify-content: space-between;
  align-items: center;
}

.nav-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  background: #83a737;
  color: white;
  font-weight: bold;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s;
  text-decoration: none;
  display: inline-block;
}

.nav-btn:hover {
  background: #6d8c2f;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(131, 167, 55, 0.3);
}

@media (min-width: 769px) {
  .header-nav {
    display: flex;
  }
}

.container {
  max-width: 600px;
  margin: auto;
  animation: fadeInUp 0.5s ease-out forwards;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(-15px); }
  to { opacity: 1; transform: translateY(0); }
}

h1 {
  text-align: center;
  margin-bottom: 15px;
  font-size: 1.5em;
}

.logo {
  display: block;
  max-width: 200px;
  height: auto;
  margin: 0 auto 15px auto;
}

.form-group {
  margin-bottom: 12px;
}

label {
  font-weight: bold;
  display: block;
  margin-bottom: 5px;
  font-size: 0.9em;
}

.required {
  color: red;
}

input, textarea, select {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 0.9em;
  box-sizing: border-box;
}

textarea {
  min-height: 60px;
  resize: vertical;
}

/* ===== Address autocomplete ===== */
ul.suggestions {
  list-style: none;
  padding: 0;
  margin: 5px 0 0 0;
  border: 1px solid #ccc;
  max-height: 150px;
  overflow-y: auto;
  background: #fff;
  border-radius: 6px;
}

ul.suggestions li {
  padding: 8px;
  cursor: pointer;
  font-size: 0.85em;
}

ul.suggestions li:hover {
  background: #eee;
}

/* ===== Floors grid ===== */
.floor-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(36px, 1fr));
  gap: 6px;
}

.floor-chip {
  background: #f1f1f1;
  border-radius: 8px;
  text-align: center;
  padding: 8px 0;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
  user-select: none;
  font-size: 0.85em;
}

.floor-chip:hover {
  transform: scale(1.05);
}

.floor-chip.active {
  background: #83a737;
  color: white;
}

/* ===== Floor box ===== */
.floor-box {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 10px;
  margin-top: 8px;
  animation: fadeInUp 0.35s ease-out forwards;
}

.floor-title {
  font-weight: bold;
  margin-bottom: 6px;
  font-size: 0.9em;
}

/* ===== Equipment ===== */
.equipment-item {
  display: flex;
  gap: 4px;
  margin-bottom: 6px;
}

.equipment-item input[type="text"] {
  flex: 3;
}

.equipment-item input[type="number"] {
  flex: 1;
}

.remove-equipment {
  width: 32px;
  min-width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #ff4444;
  color: white;
  border: none;
  font-size: 14px;
  cursor: pointer;
  padding: 0;
}

.add-btn {
  margin-top: 6px;
  background: #e0e0e0;
  border: none;
  padding: 8px;
  border-radius: 6px;
  cursor: pointer;
  width: 100%;
  font-size: 0.9em;
}

/* ===== Submit ===== */
.submit-btn {
  background: #83a737;
  color: white;
  font-weight: bold;
  border: none;
  padding: 12px;
  border-radius: 6px;
  cursor: pointer;
  width: 100%;
  font-size: 1em;
  margin-top: 10px;
}

.submit-btn:hover {
  background: #6d8c2f;
}

.success-message {
  background: #4caf50;
  color: white;
  padding: 12px;
  border-radius: 6px;
  text-align: center;
  margin-top: 15px;
  animation: fadeInUp 0.3s ease-out forwards;
}

.error-message {
  background: #f44336;
  color: white;
  padding: 12px;
  border-radius: 6px;
  text-align: center;
  margin-top: 15px;
}

/* ===== Success Overlay Animation ===== */
.success-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  animation: overlayFadeIn 0.5s ease-out forwards;
}

@keyframes overlayFadeIn {
  0% {
    opacity: 0;
    transform: scale(0.9);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

.success-checkmark {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 30px;
  animation: checkmarkPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.3s forwards;
  transform: scale(0);
}

@keyframes checkmarkPop {
  0% {
    transform: scale(0) rotate(0deg);
  }
  50% {
    transform: scale(1.2) rotate(180deg);
  }
  100% {
    transform: scale(1) rotate(360deg);
  }
}

.checkmark-icon {
  font-size: 60px;
  color: #4caf50;
  animation: checkmarkDraw 0.4s ease-out 0.6s forwards;
  opacity: 0;
}

@keyframes checkmarkDraw {
  to {
    opacity: 1;
  }
}

.success-text {
  color: white;
  font-size: 28px;
  font-weight: bold;
  margin-bottom: 10px;
  animation: textSlideUp 0.5s ease-out 0.8s forwards;
  opacity: 0;
  transform: translateY(20px);
}

@keyframes textSlideUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.success-subtext {
  color: rgba(255, 255, 255, 0.9);
  font-size: 16px;
  animation: textSlideUp 0.5s ease-out 1s forwards;
  opacity: 0;
  transform: translateY(20px);
}

.confetti {
  position: absolute;
  width: 10px;
  height: 10px;
  background: #ffd700;
  animation: confettiFall 3s linear forwards;
}

@keyframes confettiFall {
  0% {
    transform: translateY(-100vh) rotate(0deg);
    opacity: 1;
  }
  100% {
    transform: translateY(100vh) rotate(720deg);
    opacity: 0;
  }
}

</style>
</head>

<body>

<div class="header-nav">
  <a href="view.html" class="nav-btn">ליומנים</a>
  <div style="flex: 1;"></div>
  <a href="index.html" class="nav-btn">סידור עבודה</a>
</div>

<div class="container">
<img src="utech.jpg" alt="Utech" class="logo">

<form id="workForm">
<div class="form-group">
<label>שם העובד <span class="required">*</span></label>
<select id="workerName" required>
<option value="" disabled selected>בחר שם</option>
<option>פאבל</option>
<option>שי</option>
<option>ויקטור</option>
<option>פימה</option>
<option>יהונתן</option>
<option>איציק</option>
</select>
</div>

<div class="form-group">
<label>תאריך <span class="required">*</span></label>
<input type="date" id="workDate" required>
</div>

<div class="form-group">
<label>כתובת <span class="required">*</span></label>
<input type="text" id="address" placeholder="הקלד כתובת..." autocomplete="off" required>
<ul id="suggestions" class="suggestions"></ul>
</div>

<div class="form-group">
<label>בחירת קומות <span class="required">*</span></label>
<div class="floor-grid" id="floorGrid"></div>
</div>

<div id="floorWorkContainer"></div>

<div class="form-group">
<label>אביזרים וציוד שהותקנו / הוחלפו</label>
<div id="equipmentList"></div>
<button type="button" class="add-btn" onclick="addEquipment()">➕ הוסף פריט</button>
</div>

<div class="form-group">
<label>תקלות / ליקויים שהתגלו</label>
<textarea id="issues"></textarea>
</div>

<div class="form-group">
<label>מה נדרש להשלים בביקור הבא</label>
<textarea id="nextVisit"></textarea>
</div>

<button type="submit" class="submit-btn">שלח</button>
</form>

<div id="message"></div>
</div>

<script type="module">
/* ===== Firebase Setup ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDuvwDMAsyQSURluc7Mr-Ow5r2Iq2xh9P8",
  authDomain: "tofes-43c54.firebaseapp.com",
  databaseURL: "https://tofes-43c54-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "tofes-43c54",
  storageBucket: "tofes-43c54.firebasestorage.app",
  messagingSenderId: "634166786476",
  appId: "1:634166786476:web:e5118489dcf3066fcba209",
  measurementId: "G-WS6QJN5RCT"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const database = getDatabase(app);

/* ===== Storage helpers ===== */
async function saveReport(data) {
  try {
    console.log('Saving report to Firebase...');
    
    const workerName = data.workerName;
    const workDate = data.workDate;
    const address = data.address;
    
    // Structure: workLogs/{workerName}/{date}/{address}/{reportData}
    const reportPath = `workLogs/${workerName}/${workDate}/${address}`;
    const reportRef = ref(database, reportPath);
    
    await set(reportRef, {
      floors: data.floors,
      equipment: data.equipment,
      issues: data.issues,
      nextVisit: data.nextVisit,
      timestamp: data.timestamp
    });
    
    console.log('Saved successfully to Firebase at:', reportPath);
    return true;
  } catch (err) {
    console.error('Error saving to Firebase:', err);
    return false;
  }
}

/* ===== Address autocomplete ===== */
const input = document.getElementById('address');
const suggestionsList = document.getElementById('suggestions');
const GEOAPIFY_API_KEY = 'e8865b54fc1b42bb93563ff017f253af';

input.addEventListener('input', async () => {
  const query = input.value;
  if (!query || query.length < 2) {
    suggestionsList.innerHTML = '';
    return;
  }

  try {
    const response = await fetch(`https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&filter=countrycode:il&lang=he&limit=10&apiKey=${GEOAPIFY_API_KEY}`);
    const data = await response.json();

    suggestionsList.innerHTML = '';
    
    // Check if data.features exists
    if (!data.features || data.features.length === 0) {
      suggestionsList.innerHTML = '<li style="color: #999; pointer-events: none;">לא נמצאו תוצאות</li>';
      return;
    }
    
    // Filter only addresses with house numbers
    const validAddresses = data.features.filter(feature => {
      const props = feature.properties;
      return props.housenumber && props.street;
    });

    validAddresses.forEach(feature => {
      const props = feature.properties;
      const street = props.street || '';
      const housenumber = props.housenumber || '';
      const city = props.city || '';
      
      const displayText = `${street} ${housenumber}, ${city}`.trim().replace(/^,|,$/g, '');

      const li = document.createElement('li');
      li.textContent = displayText;
      li.addEventListener('click', () => {
        input.value = displayText;
        suggestionsList.innerHTML = '';
      });
      suggestionsList.appendChild(li);
    });
    
    if (validAddresses.length === 0) {
      suggestionsList.innerHTML = '<li style="color: #999; pointer-events: none;">לא נמצאו כתובות עם מספרי בית</li>';
    }
  } catch (err) {
    console.error('Autocomplete error:', err);
    suggestionsList.innerHTML = '<li style="color: #999; pointer-events: none;">שגיאה בחיפוש כתובות</li>';
  }
});

/* ===== Floors ===== */
const floorGrid = document.getElementById("floorGrid");
const floorWorkContainer = document.getElementById("floorWorkContainer");
const activeFloors = new Map();

// Create floor chips
for (let i = -5; i <= 40; i++) {
  const chip = document.createElement("div");
  chip.className = "floor-chip";
  chip.textContent = i;
  chip.addEventListener('click', () => toggleFloor(i, chip));
  floorGrid.appendChild(chip);
}

function toggleFloor(floor, chip) {
  if (activeFloors.has(floor)) {
    activeFloors.delete(floor);
    chip.classList.remove("active");
    document.querySelector(`.floor-box[data-floor="${floor}"]`)?.remove();
  } else {
    activeFloors.set(floor, '');
    chip.classList.add("active");

    const box = document.createElement("div");
    box.className = "floor-box";
    box.dataset.floor = floor;
    box.innerHTML = `
      <div class="floor-title">עבודה שבוצעה בקומה ${floor}</div>
      <textarea data-floor-textarea="${floor}" placeholder="פרט את העבודה בקומה זו"></textarea>
    `;
    
    const textarea = box.querySelector('textarea');
    textarea.addEventListener('input', (e) => {
      activeFloors.set(floor, e.target.value);
    });
    
    floorWorkContainer.appendChild(box);
  }
}

// Make toggleFloor available globally
window.toggleFloor = toggleFloor;

/* ===== Equipment ===== */
function addEquipment() {
  const div = document.createElement("div");
  div.className = "equipment-item";
  div.innerHTML = `
    <input type="text" placeholder="שם פריט" class="equipment-name">
    <input type="number" placeholder="כמות" class="equipment-quantity">
    <button type="button" class="remove-equipment">✕</button>
  `;
  
  // Add remove listener
  div.querySelector('.remove-equipment').addEventListener('click', function() {
    this.parentElement.remove();
  });
  
  document.getElementById("equipmentList").appendChild(div);
}

// Make addEquipment available globally
window.addEquipment = addEquipment;

/* ===== Set today's date by default ===== */
document.getElementById('workDate').valueAsDate = new Date();

/* ===== Form submission ===== */
document.getElementById('workForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  console.log('Form submitted!');
  
  const messageDiv = document.getElementById('message');
  
  // Validate floors
  if (activeFloors.size === 0) {
    messageDiv.innerHTML = '<div class="error-message">נא לבחור לפחות קומה אחת</div>';
    setTimeout(() => messageDiv.innerHTML = '', 3000);
    return;
  }
  
  // Collect equipment
  const equipment = [];
  document.querySelectorAll('.equipment-item').forEach(item => {
    const name = item.querySelector('.equipment-name').value;
    const quantity = item.querySelector('.equipment-quantity').value;
    if (name || quantity) {
      equipment.push({ name, quantity });
    }
  });
  
  // Collect floor work
  const floorWork = {};
  activeFloors.forEach((text, floor) => {
    const textarea = document.querySelector(`textarea[data-floor-textarea="${floor}"]`);
    floorWork[floor] = textarea ? textarea.value : text;
  });
  
  const formData = {
    workerName: document.getElementById('workerName').value,
    workDate: document.getElementById('workDate').value,
    address: document.getElementById('address').value,
    floors: floorWork,
    equipment: equipment,
    issues: document.getElementById('issues').value,
    nextVisit: document.getElementById('nextVisit').value,
    timestamp: new Date().toISOString()
  };
  
  console.log('Form data:', formData);
  
  const success = await saveReport(formData);
  
  console.log('Save result:', success);
  
  if (success) {
    // Create success overlay
    const overlay = document.createElement('div');
    overlay.className = 'success-overlay';
    overlay.innerHTML = `
      <div class="success-checkmark">
        <div class="checkmark-icon">✓</div>
      </div>
      <div class="success-text">!הדוח נשמר בהצלחה</div>
      <div class="success-subtext">הנתונים נשמרו במערכת</div>
    `;
    
    // Add confetti
    for (let i = 0; i < 50; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + '%';
      confetti.style.background = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#f7b731'][Math.floor(Math.random() * 5)];
      confetti.style.animationDelay = Math.random() * 0.5 + 's';
      confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
      overlay.appendChild(confetti);
    }
    
    document.body.appendChild(overlay);
    
    // Check what's in localStorage
    console.log('Data saved to Firebase!');
    
    setTimeout(() => {
      overlay.style.animation = 'overlayFadeIn 0.5s ease-out reverse';
      setTimeout(() => {
        overlay.remove();
        document.getElementById('workForm').reset();
        document.getElementById('workDate').valueAsDate = new Date();
        activeFloors.clear();
        document.querySelectorAll('.floor-chip').forEach(chip => chip.classList.remove('active'));
        floorWorkContainer.innerHTML = '';
        document.getElementById('equipmentList').innerHTML = '';
        suggestionsList.innerHTML = '';
      }, 500);
    }, 2500);
  } else {
    messageDiv.innerHTML = '<div class="error-message">שגיאה בשמירת הדוח. נסה שוב.</div>';
    setTimeout(() => messageDiv.innerHTML = '', 3000);
  }
});
</script>

</body>
</html>