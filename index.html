<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>טבלת משימות UTECH</title>
  <link rel="icon" href="logo.jpg" type="image/jpeg">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAFTYDz4TvUfiXx1F3xFer86WV-UMVRi7U",
      authDomain: "tablichka-e2c39.firebaseapp.com",
      databaseURL: "https://tablichka-e2c39-default-rtdb.firebaseio.com",
      projectId: "tablichka-e2c39",
      storageBucket: "tablichka-e2c39.appspot.com",
      messagingSenderId: "218058227797",
      appId: "1:218058227797:web:0525b8e6057350918c54dc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const isAdmin = { status: false };
    const names = ["טימור", "יעקב", "אלי"];
    const dayNames = ["ראשון", "שני", "שלישי", "רביעי", "חמישי"];

    function createCheckboxCell(cell, rowIndex, colIndex) {
      const container = document.createElement('div');
      container.className = 'checkboxes';

      for (let i = 1; i <= 6; i++) {
        const label = document.createElement('label');
        label.innerText = i;
        label.className = 'no-task';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        const dbKey = `notes/${rowIndex}/${colIndex}/${i}`;

        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';

        onValue(ref(db, dbKey), (snapshot) => {
          const data = snapshot.val();
          checkbox.checked = data?.checked || false;
          tooltip.innerText = data?.note || 'אין מידע';
          if (checkbox.checked) {
            label.className = 'completed';
          } else if (data?.note && data.note !== 'אין מידע') {
            label.className = 'has-task';
          } else {
            label.className = 'no-task';
          }
        });

        checkbox.addEventListener('change', () => {
          set(ref(db, dbKey), {
            checked: checkbox.checked,
            note: tooltip.innerText
          });
        });

        label.addEventListener('click', (e) => {
          if (isAdmin.status && e.target !== checkbox) {
            e.preventDefault();
            const newText = prompt('ערוך מידע עבור תיבה זו:', tooltip.innerText);
            if (newText !== null) {
              tooltip.innerText = newText;
              set(ref(db, dbKey), {
                checked: checkbox.checked,
                note: newText
              });
            }
          }
        });

        // Long press for mobile and PC
        let touchTimer;
        const showTaskOverlay = (tooltip) => {
          const overlay = document.getElementById('task-overlay');
          const overlayContent = document.getElementById('task-overlay-content');
          let lines = tooltip.innerText.split(/[\r\n]+/);
          if (lines.length === 1 && tooltip.innerText.includes('כתובת:')) {
            lines = tooltip.innerText.split(/(?=כתובת:|קוד כניסה:|טלפון \d+:|סיבה:|הערות:)/).filter(line => line.trim());
          }
          overlayContent.innerHTML = lines.map(line => {
            if (line.match(/טלפון \d+:/)) {
              const phoneMatch = line.match(/טלפון \d+: ([^,]+), שם: (.*)/);
              if (phoneMatch) {
                const phoneNumber = phoneMatch[1].trim();
                return `<p>${line}<button class="copy-phone" data-phone="${phoneNumber}">📋</button></p>`;
              }
            }
            return `<p>${line.trim()}</p>`;
          }).join('');
          overlay.style.display = 'flex';

          // Add event listeners for copy buttons
          document.querySelectorAll('.copy-phone').forEach(button => {
            button.addEventListener('click', () => {
              const phone = button.getAttribute('data-phone');
              if (navigator.clipboard) {
                navigator.clipboard.writeText(phone).then(() => {
                  alert('המספר הועתק');
                }).catch(() => {
                  alert('שגיאה בהעתקת המספר');
                });
              } else {
                alert('פונקציית ההעתקה לא נתמכת בדפדפן זה');
              }
            });
          });
        };

        label.addEventListener('touchstart', (e) => {
          if (e.target !== checkbox) {
            e.preventDefault(); // Prevent scrolling on mobile
            touchTimer = setTimeout(() => showTaskOverlay(tooltip), 500);
          }
        });

        label.addEventListener('touchend', () => {
          clearTimeout(touchTimer);
        });

        label.addEventListener('touchcancel', () => {
          clearTimeout(touchTimer);
        });

        label.addEventListener('mousedown', (e) => {
          if (e.target !== checkbox) {
            touchTimer = setTimeout(() => showTaskOverlay(tooltip), 500);
          }
        });

        label.addEventListener('mouseup', () => {
          clearTimeout(touchTimer);
        });

        label.appendChild(checkbox);
        label.appendChild(tooltip);
        container.appendChild(label);
      }

      cell.appendChild(container);
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.cell').forEach((cell, i) => {
        const rowIndex = Math.floor(i / 5);
        const colIndex = i % 5;
        createCheckboxCell(cell, rowIndex, colIndex);
      });

      document.getElementById('admin-button').addEventListener('click', () => {
        document.getElementById('admin-panel').style.display = 'block';
      });

      document.getElementById('admin-confirm').addEventListener('click', () => {
        const code = document.getElementById('admin-code').value;
        if (code === '1111') {
          isAdmin.status = true;
          alert('הכניסה בוצעה בהצלחה!');
          document.getElementById('admin-panel').style.display = 'none';
          document.getElementById('single-panel').style.display = 'block';
        } else {
          alert('קוד שגוי!');
        }
      });

      document.getElementById('admin-exit').addEventListener('click', () => {
        isAdmin.status = false;
        document.getElementById('single-panel').style.display = 'none';
        alert('יצאת ממצב מנהל');
      });

      // Dynamic phone fields
      let phoneCount = 1;
      document.getElementById('add-phone').addEventListener('click', () => {
        phoneCount++;
        const phoneList = document.getElementById('phone-list');
        const phoneEntry = document.createElement('div');
        phoneEntry.className = 'phone-entry';
        phoneEntry.innerHTML = `
          <input type="tel" class="phone-number" placeholder="הזן מספר טלפון" required>
          <input type="text" class="phone-name" placeholder="שם איש קשר" required>
          <button class="remove-phone">−</button>
        `;
        phoneList.appendChild(phoneEntry);

        // Add event listener for remove button
        phoneEntry.querySelector('.remove-phone').addEventListener('click', () => {
          if (phoneCount > 1) {
            phoneEntry.remove();
            phoneCount--;
          }
        });
      });

      document.getElementById('single-insert').addEventListener('click', () => {
        const targetName = document.getElementById('target-name').value;
        const targetDay = document.getElementById('target-day').value;
        const targetNumber = document.getElementById('target-number').value;
        const address = document.getElementById('task-address').value.trim();
        const entryCode = document.getElementById('task-entry-code').value.trim();
        const reason = document.getElementById('task-reason').value.trim();
        const comments = document.getElementById('task-comments').value.trim();

        // Collect all phone numbers and names
        const phoneEntries = document.querySelectorAll('.phone-entry');
        const phones = [];
        for (let i = 0; i < phoneEntries.length; i++) {
          const phone = phoneEntries[i].querySelector('.phone-number').value.trim();
          const name = phoneEntries[i].querySelector('.phone-name').value.trim();
          if (!phone || !name) {
            return alert("נא למלא את כל שדות הטלפון והשמות");
          }
          phones.push({ phone, name });
        }

        // Validate other fields
        if (!targetName || !targetDay || !targetNumber || !address || !entryCode || !reason || !comments) {
          return alert("נא למלא את כל השדות");
        }

        const rowIndex = names.indexOf(targetName);
        if (rowIndex === -1 || isNaN(parseInt(targetDay)) || isNaN(parseInt(targetNumber))) {
          return alert("נתונים לא תקינים");
        }

        // Format note with multiple phones
        const phoneText = phones.map((p, i) => `טלפון ${i + 1}: ${p.phone}, שם: ${p.name}`).join('\n');
        const noteText = `כתובת: ${address}\nקוד כניסה: ${entryCode}\n${phoneText}\nסיבה: ${reason}\nהערות: ${comments}`;
        const dbKey = `notes/${rowIndex}/${targetDay}/${targetNumber}`;
        set(ref(db, dbKey), {
          checked: false,
          note: noteText.trim()
        });
      });

      document.getElementById('clear-all').addEventListener('click', () => {
        set(ref(db, 'notes'), null).then(() => location.reload());
      });

      // Set dates for each day, load next week on Friday or Saturday
      const today = new Date().getDay(); // 0 = Sunday, ..., 5 = Friday, 6 = Saturday
      const now = new Date();
      const sunday = new Date(now);
      if (today === 5 || today === 6) { // Friday or Saturday: show next week
        sunday.setDate(now.getDate() - now.getDay() + 7); // Next Sunday
      } else {
        sunday.setDate(now.getDate() - now.getDay()); // Current Sunday
      }
      for (let i = 0; i < 5; i++) {
        const date = new Date(sunday);
        date.setDate(sunday.getDate() + i);
        const dd = String(date.getDate()).padStart(2, '0');
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const th = document.getElementById(`day-${i}`);
        th.innerText = `${dayNames[i]} ${dd}.${mm}`;
        if (i === today && today <= 4 && today !== 5 && today !== 6) {
          th.classList.add('today');
        }
      }

      const daySelect = document.getElementById('day-select');
      if (today >= 0 && today <= 4 && today !== 5 && today !== 6) {
        daySelect.value = today;
      } else {
        daySelect.value = 0;
      }

      function updateTableDisplay() {
        const selectedDay = parseInt(daySelect.value);
        const isMobile = window.matchMedia("(max-width: 600px)").matches;
        document.querySelectorAll('th[id^="day-"], td.cell').forEach((el) => {
          const colIndex = parseInt(el.id?.split('-')[1]) || Array.from(el.parentNode.children).indexOf(el) - 1;
          el.style.display = isMobile && colIndex !== selectedDay ? 'none' : '';
        });
      }

      daySelect.addEventListener('change', updateTableDisplay);
      window.addEventListener('resize', updateTableDisplay);
      updateTableDisplay();

      // Close task overlay only when clicking outside content
      document.getElementById('task-overlay').addEventListener('click', (e) => {
        if (e.target === document.getElementById('task-overlay')) {
          document.getElementById('task-overlay').style.display = 'none';
        }
      });

      // Persistent back confirmation on mobile
      if (window.matchMedia("(max-width: 600px)").matches) {
        history.pushState({ page: 'main' }, null, location.href);
        window.addEventListener('popstate', (event) => {
          if (event.state?.page === 'main') {
            document.getElementById('back-confirm-overlay').style.display = 'flex';
            history.pushState({ page: 'confirm' }, null, location.href);
          } else if (event.state?.page === 'confirm') {
            document.getElementById('back-confirm-overlay').style.display = 'none';
            window.history.go(-2); // Exit the site
          }
        });

        document.getElementById('back-cancel').addEventListener('click', () => {
          document.getElementById('back-confirm-overlay').style.display = 'none';
          history.pushState({ page: 'main' }, null, location.href);
        });
      }
    });
  </script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #ffffff;
      margin: 0;
      position: relative;
    }
    .header-image {
      width: 100%;
      max-width: 300px;
      height: auto;
      object-fit: contain;
      display: block;
      margin: 10px auto;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 100%;
      margin: 10px 0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      vertical-align: top;
      position: relative;
    }
    th {
      background: #70ac4c;
      color: white;
    }
    .today {
      background: #5ca026 !important;
    }
    th.name {
      background: #f09c9c;
    }
    .checkboxes label {
      display: inline-block;
      margin: 0 2px;
      position: relative;
      font-weight: bold;
    }
    .no-task {
      color: black;
    }
    .has-task {
      color: red;
    }
    .completed {
      color: green;
    }
    .tooltip {
      display: none;
      position: absolute;
      bottom: 100%;
      right: 0;
      background: #fff;
      border: 1px solid #ccc;
      padding: 8px;
      z-index: 10;
      max-width: 200px;
      white-space: pre-line;
      font-size: 0.9em;
    }
    label:hover .tooltip {
      display: block;
    }
    #day-select {
      display: block;
      margin: 10px auto;
      padding: 5px;
      font-size: 1em;
      width: 200px;
    }
    #admin-button {
      position: fixed;
      bottom: 10px;
      left: 10px;
      padding: 8px 12px;
      font-size: 0.9em;
    }
    #admin-panel, #single-panel {
      display: none;
      position: fixed;
      bottom: 50px;
      left: 10px;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      width: 280px;
      max-width: 90%;
      z-index: 100;
    }
    textarea, input, select {
      width: 100%;
      margin-bottom: 8px;
      padding: 5px;
      font-size: 0.9em;
    }
    button {
      padding: 8px;
      font-size: 0.9em;
      width: 100%;
      margin-bottom: 5px;
    }
    .required {
      color: red;
    }
    #phone-list {
      margin-bottom: 5px;
    }
    .phone-entry {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .phone-number {
      width: 65%;
      margin-left: 5px;
    }
    .phone-name {
      width: 35%;
    }
    #add-phone {
      display: block;
      padding: 5px;
      font-size: 1em;
      width: auto;
      background: #70ac4c;
      color: white;
      border: none;
      border-radius: 4px;
      margin: 5px 0;
    }
    .remove-phone {
      padding: 5px;
      font-size: 1em;
      width: auto;
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 4px;
      margin-right: 5px;
    }
    #task-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 200;
      justify-content: center;
      align-items: center;
    }
    #task-overlay-content {
      background: #fff;
      padding: 20px;
      max-width: 90%;
      max-height: 80%;
      overflow-y: auto;
      font-size: 1.5em;
      text-align: right;
      border-radius: 8px;
      white-space: pre-line;
      line-height: 2;
    }
    #task-overlay-content p {
      margin: 0 0 15px 0;
      direction: rtl;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }
    .copy-phone {
      display: none;
      width: auto;
      height: auto;
      padding: 0;
      font-size: 1em;
      background: none;
      border: none;
      cursor: pointer;
      margin-right: 5px;
      line-height: 1;
      text-align: center;
    }
    #back-confirm-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 300;
      justify-content: center;
      align-items: center;
    }
    #back-confirm-content {
      background: #fff;
      padding: 20px;
      max-width: 90%;
      text-align: center;
      border-radius: 8px;
      font-size: 1.2em;
    }
    #back-cancel {
      margin-top: 10px;
      padding: 8px 16px;
      font-size: 1em;
      background: #70ac4c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      .header-image {
        max-width: 150px;
        margin: 5px auto;
      }
      table {
        font-size: 0.85em;
      }
      th, td {
        padding: 5px;
      }
      .checkboxes label {
        margin: 0 1px;
      }
      .tooltip {
        max-width: 150px;
        font-size: 0.8em;
      }
      #day-select {
        width: 150px;
        font-size: 0.9em;
      }
      #admin-button, #admin-panel, #single-panel {
        display: none;
      }
      .copy-phone {
        display: inline-block;
      }
      .phone-number {
        width: 60%;
      }
      .phone-name {
        width: 40%;
      }
    }

    @media (min-width: 601px) {
      #day-select {
        display: none;
      }
    }
  </style>
</head>
<body>
  <img src="utech.jpg" alt="Utech Logo" class="header-image">
  <select id="day-select">
    <option value="0">ראשון</option>
    <option value="1">שני</option>
    <option value="2">שלישי</option>
    <option value="3">רביעי</option>
    <option value="4">חמישי</option>
  </select>
  <table id="schedule-table">
    <thead>
      <tr>
        <th class="name">שם</th>
        <th id="day-0">ראשון</th>
        <th id="day-1">שני</th>
        <th id="day-2">שלישי</th>
        <th id="day-3">רביעי</th>
        <th id="day-4">חמישי</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>טימור</td><td class="cell"></td><td class="cell"></td><td class="cell"></td><td class="cell"></td><td class="cell"></td></tr>
      <tr><td>יעקב</td><td class="cell"></td><td class="cell"></td><td class="cell"></td><td class="cell"></td><td class="cell"></td></tr>
      <tr><td>אלי</td><td class="cell"></td><td class="cell"></td><td class="cell"></td><td class="cell"></td><td class="cell"></td></tr>
    </tbody>
  </table>

  <button id="admin-button">🔒 כניסת מנהל</button>
  <div id="admin-panel">
    <label>קוד גישה: <input type="password" id="admin-code"></label>
    <button id="admin-confirm">אישור</button>
  </div>

  <div id="single-panel">
    <label>שם:<span class="required">*</span>
      <select id="target-name" required>
        <option value="">בחר שם</option>
        <option>טימור</option>
        <option>יעקב</option>
        <option>אלי</option>
      </select>
    </label>
    <label>יום:<span class="required">*</span>
      <select id="target-day" required>
        <option value="">בחר יום</option>
        <option value="0">ראשון</option>
        <option value="1">שני</option>
        <option value="2">שלישי</option>
        <option value="3">רביעי</option>
        <option value="4">חמישי</option>
      </select>
    </label>
    <label>מספר משימה:<span class="required">*</span>
      <select id="target-number" required>
        <option value="">בחר מספר</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
      </select>
    </label>
    <label>כתובת:<span class="required">*</span>
      <input type="text" id="task-address" required placeholder="הזן כתובת">
    </label>
    <label>קוד כניסה:<span class="required">*</span>
      <input type="text" id="task-entry-code" required placeholder="הזן קוד כניסה">
    </label>
    <label>טלפון:<span class="required">*</span></label>
    <div id="phone-list">
      <div class="phone-entry">
        <input type="tel" class="phone-number" placeholder="הזן מספר טלפון" required>
        <input type="text" class="phone-name" placeholder="שם איש קשר" required>
      </div>
    </div>
    <button id="add-phone">+</button>
    <label>סיבה:<span class="required">*</span>
      <input type="text" id="task-reason" required placeholder="הזן סיבה">
    </label>
    <label>הערות:<span class="required">*</span>
      <textarea id="task-comments" required placeholder="הזן הערות"></textarea>
    </label>
    <button id="single-insert">💾 שמור משימה</button>
    <button id="clear-all">🗑️ נקה הכל</button>
    <button id="admin-exit">יציאה ממצב מנהל</button>
  </div>

  <div id="task-overlay">
    <div id="task-overlay-content"></div>
  </div>

  <div id="back-confirm-overlay">
    <div id="back-confirm-content">
      <p>לחץ שוב על "חזור" כדי לצאת</p>
      <button id="back-cancel">ביטול</button>
    </div>
  </div>
</body>
</html>
