<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>יומן עבודה</title>

<style>
/* ===== Base ===== */
body {
  font-family: Arial, sans-serif;
  background: #ffffff;
  padding: 10px;
  margin: 0;
}

.container {
  max-width: 600px;
  margin: auto;
  animation: fadeInUp 0.5s ease-out forwards;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(-15px); }
  to { opacity: 1; transform: translateY(0); }
}

h1 {
  text-align: center;
  margin-bottom: 15px;
  font-size: 1.5em;
}

.logo {
  display: block;
  max-width: 200px;
  height: auto;
  margin: 0 auto 15px auto;
}

.form-group {
  margin-bottom: 12px;
}

label {
  font-weight: bold;
  display: block;
  margin-bottom: 5px;
  font-size: 0.9em;
}

.required {
  color: red;
}

input, textarea, select {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 0.9em;
  box-sizing: border-box;
}

textarea {
  min-height: 60px;
  resize: vertical;
}

/* ===== Address autocomplete ===== */
ul.suggestions {
  list-style: none;
  padding: 0;
  margin: 5px 0 0 0;
  border: 1px solid #ccc;
  max-height: 150px;
  overflow-y: auto;
  background: #fff;
  border-radius: 6px;
}

ul.suggestions li {
  padding: 8px;
  cursor: pointer;
  font-size: 0.85em;
}

ul.suggestions li:hover {
  background: #eee;
}

/* ===== Floors grid ===== */
.floor-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(42px, 1fr));
  gap: 6px;
}

.floor-chip {
  background: #f1f1f1;
  border-radius: 8px;
  text-align: center;
  padding: 8px 0;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
  user-select: none;
  font-size: 0.85em;
}

.floor-chip:hover {
  transform: scale(1.05);
}

.floor-chip.active {
  background: #83a737;
  color: white;
}

/* ===== Floor box ===== */
.floor-box {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 10px;
  margin-top: 8px;
  animation: fadeInUp 0.35s ease-out forwards;
}

.floor-title {
  font-weight: bold;
  margin-bottom: 6px;
  font-size: 0.9em;
}

/* ===== Equipment ===== */
.equipment-item {
  display: flex;
  gap: 4px;
  margin-bottom: 6px;
}

.equipment-item input[type="text"] {
  flex: 3;
}

.equipment-item input[type="number"] {
  flex: 1;
}

.remove-equipment {
  width: 32px;
  min-width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #ff4444;
  color: white;
  border: none;
  font-size: 14px;
  cursor: pointer;
  padding: 0;
}

.add-btn {
  margin-top: 6px;
  background: #e0e0e0;
  border: none;
  padding: 8px;
  border-radius: 6px;
  cursor: pointer;
  width: 100%;
  font-size: 0.9em;
}

/* ===== Submit ===== */
.submit-btn {
  background: #83a737;
  color: white;
  font-weight: bold;
  border: none;
  padding: 12px;
  border-radius: 6px;
  cursor: pointer;
  width: 100%;
  font-size: 1em;
  margin-top: 10px;
}

.submit-btn:hover {
  background: #6d8c2f;
}

.success-message {
  background: #4caf50;
  color: white;
  padding: 12px;
  border-radius: 6px;
  text-align: center;
  margin-top: 15px;
  animation: fadeInUp 0.3s ease-out forwards;
}

.error-message {
  background: #f44336;
  color: white;
  padding: 12px;
  border-radius: 6px;
  text-align: center;
  margin-top: 15px;
}

</style>
</head>

<body>

<div class="container">
<img src="utech.jpg" alt="Utech" class="logo">

<form id="workForm">
<div class="form-group">
<label>שם העובד <span class="required">*</span></label>
<select id="workerName" required>
<option value="" disabled selected>בחר שם</option>
<option>פאבל</option>
<option>שי</option>
<option>ויקטור</option>
<option>פימה</option>
<option>יהונתן</option>
<option>איציק</option>
</select>
</div>

<div class="form-group">
<label>כתובת <span class="required">*</span></label>
<input type="text" id="address" placeholder="הקלד כתובת..." autocomplete="off" required>
<ul id="suggestions" class="suggestions"></ul>
</div>

<div class="form-group">
<label>בחירת קומות <span class="required">*</span></label>
<div class="floor-grid" id="floorGrid"></div>
</div>

<div id="floorWorkContainer"></div>

<div class="form-group">
<label>אביזרים וציוד שהותקנו / הוחלפו</label>
<div id="equipmentList"></div>
<button type="button" class="add-btn" onclick="addEquipment()">➕ הוסף פריט</button>
</div>

<div class="form-group">
<label>תקלות / ליקויים שהתגלו</label>
<textarea id="issues"></textarea>
</div>

<div class="form-group">
<label>מה נדרש להשלים בביקור הבא</label>
<textarea id="nextVisit"></textarea>
</div>

<button type="submit" class="submit-btn">שלח</button>
</form>

<div id="message"></div>
</div>

<script>
/* ===== Storage helpers ===== */
async function saveReport(data) {
  try {
    const key = `report:${Date.now()}`;
    await window.storage.set(key, JSON.stringify(data));
    return true;
  } catch (err) {
    console.error('Error saving:', err);
    return false;
  }
}

/* ===== Address autocomplete ===== */
const input = document.getElementById('address');
const suggestionsList = document.getElementById('suggestions');
const GEOAPIFY_API_KEY = 'e8865b54fc1b42bb93563ff017f253af';

input.addEventListener('input', async () => {
  const query = input.value;
  if (!query) {
    suggestionsList.innerHTML = '';
    return;
  }

  try {
    const response = await fetch(`https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&filter=countrycode:il&lang=he&limit=5&apiKey=${GEOAPIFY_API_KEY}`);
    const data = await response.json();

    suggestionsList.innerHTML = '';
    data.features.forEach(feature => {
      const props = feature.properties;
      const street = props.street || '';
      const housenumber = props.housenumber || '';
      const city = props.city || '';
      
      const displayText = `${street} ${housenumber}, ${city}`.trim().replace(/^,|,$/g, '');

      const li = document.createElement('li');
      li.textContent = displayText;
      li.addEventListener('click', () => {
        input.value = displayText;
        suggestionsList.innerHTML = '';
      });
      suggestionsList.appendChild(li);
    });
  } catch (err) {
    console.error('Autocomplete error:', err);
  }
});

/* ===== Floors ===== */
const floorGrid = document.getElementById("floorGrid");
const floorWorkContainer = document.getElementById("floorWorkContainer");
const activeFloors = new Map();

for (let i = -5; i <= 20; i++) {
  const chip = document.createElement("div");
  chip.className = "floor-chip";
  chip.textContent = i;
  chip.onclick = () => toggleFloor(i, chip);
  floorGrid.appendChild(chip);
}

function toggleFloor(floor, chip) {
  if (activeFloors.has(floor)) {
    activeFloors.delete(floor);
    chip.classList.remove("active");
    document.querySelector(`.floor-box[data-floor="${floor}"]`)?.remove();
  } else {
    activeFloors.set(floor, '');
    chip.classList.add("active");

    const box = document.createElement("div");
    box.className = "floor-box";
    box.dataset.floor = floor;
    box.innerHTML = `
      <div class="floor-title">עבודה שבוצעה בקומה ${floor}</div>
      <textarea data-floor-textarea="${floor}" placeholder="פרט את העבודה בקומה זו"></textarea>
    `;
    
    const textarea = box.querySelector('textarea');
    textarea.addEventListener('input', (e) => {
      activeFloors.set(floor, e.target.value);
    });
    
    floorWorkContainer.appendChild(box);
  }
}

/* ===== Equipment ===== */
function addEquipment() {
  const div = document.createElement("div");
  div.className = "equipment-item";
  div.innerHTML = `
    <input type="text" placeholder="שם פריט" class="equipment-name">
    <input type="number" placeholder="כמות" class="equipment-quantity">
    <button type="button" class="remove-equipment" onclick="this.parentElement.remove()">✕</button>
  `;
  document.getElementById("equipmentList").appendChild(div);
}

/* ===== Form submission ===== */
document.getElementById('workForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const messageDiv = document.getElementById('message');
  
  // Validate floors
  if (activeFloors.size === 0) {
    messageDiv.innerHTML = '<div class="error-message">נא לבחור לפחות קומה אחת</div>';
    setTimeout(() => messageDiv.innerHTML = '', 3000);
    return;
  }
  
  // Collect equipment
  const equipment = [];
  document.querySelectorAll('.equipment-item').forEach(item => {
    const name = item.querySelector('.equipment-name').value;
    const quantity = item.querySelector('.equipment-quantity').value;
    if (name || quantity) {
      equipment.push({ name, quantity });
    }
  });
  
  // Collect floor work
  const floorWork = {};
  activeFloors.forEach((text, floor) => {
    const textarea = document.querySelector(`textarea[data-floor-textarea="${floor}"]`);
    floorWork[floor] = textarea ? textarea.value : text;
  });
  
  const formData = {
    workerName: document.getElementById('workerName').value,
    address: document.getElementById('address').value,
    floors: floorWork,
    equipment: equipment,
    issues: document.getElementById('issues').value,
    nextVisit: document.getElementById('nextVisit').value,
    timestamp: new Date().toISOString()
  };
  
  const success = await saveReport(formData);
  
  if (success) {
    messageDiv.innerHTML = '<div class="success-message">הדוח נשמר בהצלחה! ✓</div>';
    setTimeout(() => {
      messageDiv.innerHTML = '';
      document.getElementById('workForm').reset();
      activeFloors.clear();
      document.querySelectorAll('.floor-chip').forEach(chip => chip.classList.remove('active'));
      floorWorkContainer.innerHTML = '';
      document.getElementById('equipmentList').innerHTML = '';
      suggestionsList.innerHTML = '';
    }, 2000);
  } else {
    messageDiv.innerHTML = '<div class="error-message">שגיאה בשמירת הדוח. נסה שוב.</div>';
    setTimeout(() => messageDiv.innerHTML = '', 3000);
  }
});
</script>

</body>
</html>